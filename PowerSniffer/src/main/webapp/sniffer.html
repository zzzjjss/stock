<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="jquery/jquery-3.1.1.min.js"></script>
<script type="text/javascript"
	src="jquery/jquery.dataTables/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="bootstrap-3.3.5/js/bootstrap.min.js"></script>
<link rel="stylesheet" type="text/css"
	href="jquery/jquery.dataTables/jquery.dataTables.min.css" />
<link rel="stylesheet" type="text/css"
	href="bootstrap-3.3.5/css/bootstrap.min.css" />
<link rel="stylesheet" type="text/css"
	href="bootstrap-3.3.5/css/bootstrap-theme.min.css" />
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<div class="panel panel-default">
		<div class="panel-heading">
			<h3 class="panel-title">Dashboard</h3>
		</div>
		<div class="panel-body" id="dashboard"  style="max-height: 600px;overflow-y: scroll;"></div>
	</div>
</body>
<script type="text/javascript">
var socket;
var webSocketUrl='ws://' + window.location.host + '/PowerSniffer/alarm';
$(document).ready(function() {
	socket=new WebSocket(webSocketUrl);
	socket.onmessage = function (message) {
							//alert(message.data);
							refreshDashboard(JSON.parse(message.data));
			                //console.log(message.data);
			            };
      
      window.setInterval(checkWebSocketConnection,5000);

});


function checkWebSocketConnection(){
	if(socket.readyState!=socket.OPEN){
		console.log("webSocket is closed ,reconnecting...");
		socket=new WebSocket(webSocketUrl);
		socket.onmessage = function (message) {
			refreshDashboard(JSON.parse(message.data));
        };
	}else{
		console.log("webSocket is open");
	}
	
}
function refreshDashboard(alarmDatas){
	var alertMsg="";
	for(var i=0;i<alarmDatas.length;i++){
		var stock=alarmDatas[i];
		if($("span[id="+stock.stockSymbol+"]").length==0){
			alertMsg=alertMsg+stock.msgType+":"+stock.stockSymbol+"\n";
		}	
	}
	if(alertMsg!=""){
		alert(alertMsg);
	}
	$("#dashboard span").remove();
	for(var i=0;i<alarmDatas.length;i++){
		var stock=alarmDatas[i];
		//$("#dashboard").append('<span id="'+stock.stockSymbol+'"><a  target="_blank" href="http://q.stock.sohu.com/cn/'+stock.stockSymbol.substring(2)+'/index.shtml">'+stock.stockName+'</a>--->'+upDown+'--->'+stock.power+'<br></span>');
		$("#dashboard").append('<span id="'+stock.stockSymbol+'"><a  target="_blank" href="http://finance.sina.com.cn/realstock/company/'+stock.stockSymbol+'/nc.shtml">'+stock.stockName+'</a>--->'+stock.msgType+'<br></span>');
	}
}
</script>
</html>